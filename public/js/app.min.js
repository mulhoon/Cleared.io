/*!
 * DO NOT EDIT THIS FILE
 * File concatatenated by grunt @ 2015-02-27 11:54
 * Cleared.io
 * 
 * 
 * @author Nic Mulvaney
 * @version 0.0.1
 * Copyright 2015. MIT licensed.
 */


function save(el){return savedSel=rangy.getSelection().saveCharacterRanges(el)}function restore(el,offset,selection){selection&&(savedSel=selection),offset&&(savedSel[0].characterRange.start+=offset,savedSel[0].characterRange.end+=offset),rangy.getSelection().restoreCharacterRanges(el,savedSel)}function reverseForIn(obj,f){var arr=[];for(var key in obj)arr.push(key);for(var i=arr.length-1;i>=0;i--)f.call(obj,arr[i])}var App=App||{},scripts=[{jquery:"js/vendor/jquery-2.1.3.min.js"},{device:"js/vendor/device.min.js"},{moment:"js/vendor/moment.min.js"},{chosen:"js/vendor/chosen.jquery.min.js"},{rangycore:"js/vendor/rangy/rangy-core.js"},{rangytextrange:"js/vendor/rangy/rangy-textrange.js"},{undo:"js/vendor/undomanager.js"},{storage:"js/vendor/localforage.min.js"},{switchery:"js/vendor/switchery.min.js"},{fontloader:"js/vendor/webfontloader.js"},{firebase:"https://cdn.firebase.com/js/client/2.2.0/firebase.js"},{autolink:"js/vendor/ba-linkify.min.js"}],event_down,event_move,event_release,transition="transitionend webkitTransitionEnd",animation="animationend webkitAnimationEnd";App.view=function(){var body,selectedElement,sidebar,newfile,files,style,saveTimer,undoManager,oldhtml,oldcursor,_filtered,_filter,currentKey={keyCode:null},adapter="storage",options={saveDelay:{value:500},appendDate:{value:!0,name:"Append date to <span class='tag' data-id='#done'>#done</span>",visible:!0},spellcheck:{value:!0,name:"Spell check",visible:!0,func:function(value){edit[0].spellcheck=value,edit[0].focus(),edit[0].blur()}},smallfont:{value:!1,name:"Use small font",visible:!0,func:function(value){value?body.css({"font-size":"15px"}):body.attr("style","")}}},shortcuts={68:function(){selectedElement.find(".mark").trigger(event_down)},38:function(){moveItem(-1)},40:function(){moveItem(1)}},_checkbox=["☐","-","*","-[ ]"],_checkbox_ticked=["☑","✔"],_checkbox_invalid=["☒","✘"],_all=_checkbox.concat(_checkbox_ticked).concat(_checkbox_invalid),_default="<p><br/></p>",tick='<span class="mark tick">'+_checkbox[0]+"</span>",tock='<span class="mark tock">'+_checkbox_ticked[0]+"</span>",invalid='<span class="mark invalid">'+_checkbox_invalid[0]+"</span>",init=function(){body=$("body"),style=$("#style"),edit=$("#edit"),sidebar=$("#sidebar"),files=$("#files"),newfile=$(".newfile-button"),settingbut=$(".setting-button"),search=$("#search input"),signin=$("#signin-google"),selectedElement=$("<div/>"),App.storage.init(),App.cloud.init(),actions(),rangy.init(),$(".chosen").chosen().change(runSearch),undoManager=new UndoManager,settings(),WebFont.load({custom:{families:["AvenirNextLTPro-Medium","AvenirNextLTPro-Regular","AvenirNextLTPro-UltLt"]},active:function(){},inactive:function(){}})},setUser=function(user){user?($(".user").html("signed in as "+user[user.provider].displayName+' <a href="#logout">sign out</a>').show(),signin.hide(),adapter="cloud"):($(".user").text("").hide(),signin.show(),adapter="storage"),App[adapter].load(function(_files){updateFileList(_files),$("#files .file.active").length||$("#files .file").eq(0).trigger(event_release)})},settings=function(){var html="";for(var key in options){var a=options[key];a.visible&&(html+='<div class="row">'+a.name+'<input type="checkbox" id="'+key+'" class="js-switch" '+(a.value?"checked":"")+' /><div class="clear"></div></div>')}$(".settings .middle").html(html);var switches=$(".settings input");switches.each(function(i,a){new Switchery(a,{size:"small",color:"#3D9970"});a.onchange=function(){var id=$(this).attr("id");options[id].value=this.checked,options[id].func&&options[id].func(this.checked)}})},addUndo=function(attrs){undoManager.add({undo:function(){edit.html(attrs.oldhtml),extractTags(),requestAnimationFrame(function(){restore(edit[0],0,attrs.oldcursor)})},redo:function(){edit.html(attrs.html),extractTags(),requestAnimationFrame(function(){restore(edit[0],0,attrs.cursor)})}})},parseTags=function(str,type,identifier,identifierEnd){var tags={},tagString=[];identifierEnd=identifierEnd?"+["+identifierEnd+"]":"";var reg=new RegExp("["+identifier+"]+[A-Za-z0-9-_]"+identifierEnd+"+","g"),html=str.replace(reg,function(u){var name=u.slice(1).split("(")[0];return tags[name]=tags[name]||{count:0},tags[name].name=name,tags[name].id=identifier+name,tags[name].html="<span class='"+type+"' data-id='"+identifier+name+"'>"+u+"</span>",tags[name].count++,tags[name].html});for(var tag in tags)tagString.push(identifier+tag);return tagString=tagString.join(" "),{type:type,html:html,tags:tags,tagString:tagString}},parseLinks=function(str){return{html:linkify(str)}},inArr=function(value,arr){for(var i=0;i<arr.length;i++)if(value===arr[i]+" ")return!0;return!1},parseTodo=function(str,tags){var classStr="",start=str.slice(0,2);if(inArr(start,_all)){var tickEl="";str.length>=2&&(tickEl=tick),tags&&(tags.done&&(tickEl=tock),tags.invalid&&(tickEl=invalid)),str=tickEl+" "+str.slice(2),classStr="todo"}return{html:str,todo:classStr}},parseTitles=function(str){var end=str.slice(-1);return{html:str,classStr:":"===end?" title":""}},actions=function(){$(window).on("keydown",function(e){if(currentKey={keyCode:e.keyCode,altKey:e.altKey,ctrlKey:e.ctrlKey,metaKey:e.metaKey,shiftKey:e.shiftKey},currentKey.metaKey&&shortcuts[currentKey.keyCode])return shortcuts[currentKey.keyCode](),void e.preventDefault();var selection,start,end;if(13===e.keyCode){selection=save(selectedElement[0])[0].characterRange,start=selection.start,end=selection.end;var text=selectedElement.text(),pos=text.length,newStr=text.substr(end,pos-end),oldStr=text.substr(0,start),cursorOffest=0,isTodo=selectedElement.hasClass("todo"),isTitle=selectedElement.hasClass("title"),isEnd=end===pos,isStart=0===start,additions=newStr;isTodo&&!parseTodo(newStr).todo&&(additions="- "+additions,cursorOffest=2),(!text||isTodo||isTitle&&!isEnd)&&selectedElement.attr("class","").removeAttr("data-id data-children");var parentTitle=isTitle?selectedElement:selectedElement.prevAll(".title").eq(0),parentTags=$.trim(parentTitle.attr("data-id"));if(parentTags&&(additions+=" "+parentTags),_filtered&&(additions+=" "+_filter),$.trim(oldStr)===_checkbox[0])return newStr=newStr?newStr:"<br/>",selectedElement.html(newStr).removeClass("todo"),setCursor(selectedElement[0]),e.preventDefault(),void document.delayFocus();if(isTodo&&!isStart||isTitle&&!isEnd&&!isStart||parentTags||_filtered){newStr=additions,newStr=newStr?newStr:"<br/>",selectedElement.text(oldStr),formatLine();var newP=$("<p>"+newStr+"</p>");return newP.insertAfter(selectedElement),setCursor(newP[0],cursorOffest),setFocus(),formatLine(newP),document.delayFocus(),void e.preventDefault()}}if(40===e.keyCode){selection=save(selectedElement[0]);var len=selectedElement.next().text().length;return selection[0].characterRange.start>len&&(selection[0].characterRange.start=len,selection[0].characterRange.end=len),restore(selectedElement.next()[0],0,selection),document.delayFocus(),void e.preventDefault()}document.delayFocus(),e.metaKey&&90===e.keyCode&&(e.shiftKey&&e.metaKey&&90===e.keyCode?undoManager.hasRedo()&&undoManager.redo():e.metaKey&&90===e.keyCode&&undoManager.hasUndo()&&undoManager.undo())}).on("keyup",function(){currentKey={keyCode:null}}),document.delayFocus=function(){requestAnimationFrame(function(){setFocus()})},edit.on("click","p",function(){setFocus($(this))}),edit.on(event_release,"p",function(){requestAnimationFrame(function(){setFocus()})}),edit.on(event_down,".mark",toggleDone),body.on("click","a",openURL);edit.on("input",function(){var value=edit.html();return value?opening?!1:(setFocus(),selectedElement&&formatLine(),clearTimeout(saveTimer),void(saveTimer=setTimeout(function(){extractTags();var html=edit.html(),cursor=save(edit[0]);if(html!==oldhtml){addUndo({oldhtml:oldhtml,html:html,oldcursor:oldcursor,cursor:cursor});var txt=getAllText();App[adapter].save(txt,trimmedTitle(txt))}oldhtml=html,oldcursor=cursor},options.saveDelay.value))):(setDefault(),!1)}).on(event_down,function(){body.addClass("hideMenu").removeClass("settings")}),edit[0].addEventListener("copy",copy),edit[0].addEventListener("paste",paste),files.on(event_release,".file",function(){var index=$(this).data().id;$("#files .file").removeClass("active"),$(this).addClass("active"),App[adapter].open(index,setAndParse)}),newfile.on(event_release,function(){App[adapter].add(function(id){$("#files .file[data-id="+id+"]").trigger(event_release)})}),settingbut.on(event_release,function(){body.toggleClass("settings")}),signin.on(event_release,App.cloud.login),$(".close, .menu").on(event_release,function(){body.hasClass("settings")?body.removeClass("settings"):body.toggleClass("hideMenu")}),files.on(event_release,".trash",function(e){var index=$(this).parent().data().id,r=confirm("Are you sure you want to delete this?");r&&App[adapter].remove(index,function(){$("#files .file").eq(0).trigger(event_release)}),e.preventDefault(),e.stopPropagation()})},copy=function(){},paste=function(e){e.preventDefault();var selection=save(edit[0])[0].characterRange,text=(selection.start,selection.end,e.clipboardData.getData("text/plain"));text=p(text),document.execCommand("insertHTML",!1,text),opening=!0,edit.find("p").each(function(i,a){formatLine($(a))}),opening=!1},openURL=function(e){var url=$(this).attr("href");"#"===url.slice(0,1)?App.view[url.slice(1)]():window.open(url,"_blank"),e.preventDefault(),e.stopPropagation()},runSearch=function(){var chosen=$(".chosen option:selected"),value=[];$(chosen).each(function(){value.push($(this).attr("value"))}),value=value?value.join(" "):"";var tags=parseTags(value,"tag","#"),mentions=parseTags(value,"mention","@");filterPage($.extend(tags.tags,mentions.tags))},p=function(t){return t=$.trim(t),(t.length>0?"<p>"+t.replace(/\r?\n/g,"</p><p>")+"</p>":"").replace(/<p><\/p> | <p><br><\/p>/g,"")},moveItem=function(direction){save(selectedElement[0]),1===direction?selectedElement.insertAfter(selectedElement.next()):selectedElement.insertBefore(selectedElement.prev()),restore(selectedElement[0]),selectedElement.addClass("blink").on(animation,function(){$(this).removeClass("blink")})},formatLine=function(node){var container=node||selectedElement,text=(container.prev(),container.text()),titles=parseTitles(text),highlight=parseTags(titles.html,"highlight","*","*"),tags=parseTags(highlight.html,"tag","#"),mentions=parseTags(tags.html,"mention","@"),links=parseLinks(mentions.html),todo=parseTodo(links.html,tags.tags),newText=todo.html,attr=tags.tagString+" "+mentions.tagString;newText=newText?newText:"<br/>",opening||save(container[0]),container.html(newText).attr("class",titles.classStr+todo.todo).attr("data-id",attr),opening||restore(container[0])},getAllText=function(){return edit[0].innerText},parseAll=function(){var groupTitle,oldNode,gt,nodes=edit.find("p"),text=(nodes.length,""),tagStr="";return nodes.each(function(i,a){var node=$(a),classList=node[0].classList,isTitle=classList.contains("title");groupTitle=isTitle?node:groupTitle,groupTitle!==oldNode&&(tagStr="",gt=groupTitle),text+=node.text()+"\n",isTitle||(tagStr+=node.attr("data-id")+" "),gt&&gt.attr("data-children",$.trim(tagStr)),oldNode=groupTitle}),text},addSearchOptions=function(options){if($.isEmptyObject(options[0].tags)&&$.isEmptyObject(options[1].tags))return void $("#search").hide();var filters,html="";filters=_filtered?_filter.split(" "):[];for(var group in options){html+='<optgroup label="'+options[group].group+'">';for(var key in options[group].tags){var tag=options[group].tags[key].id;html+="<option value="+tag+' data-type="file" ',html+=-1!==$.inArray(tag,filters)?"selected":"",html+=">"+tag+"</option>"}html+="</optgroup>"}$(".chosen").html(html).trigger("chosen:updated"),$("#search").show()},extractTags=function(){var text=parseAll();updateFileListItem(text);var tags=parseTags(text,"tag","#").tags,mentions=parseTags(text,"mention","@").tags;addSearchOptions([{group:"Tags",tags:tags},{group:"Mentions",tags:mentions}])},filterPage=function(items){var html="#edit p{display:none;} ",htmlTags="#edit p",htmlTitles="#edit p";_filter="";for(var key in items){var tag=items[key].id;htmlTags+='[data-id~="'+tag+'"]',htmlTitles+='[data-children~="'+tag+'"]',_filter+=tag+" "}html+=htmlTags+","+htmlTitles+"{display:block;}\n",style.html(html),_filtered=!0},setAndParse=function(file,clear){var value=file.text,currentValue=getAllText();if(value===currentValue)return void console.log("updateCancelled");style.html(""),$(".chosen").val("").trigger("chosen:updated");var text,isReset;value?(text=p(value),isReset=!1):(text=_default,isReset=!0),opening=!0,edit.html(text),edit.find("p").each(function(i,a){formatLine($(a))}),selectedElement=edit.find("p").eq(0),opening=!1,oldhtml=edit.html(),oldcursor=save(edit[0]),setTimeout(function(){isReset&&!clear&&setCursor(),clear||extractTags()},1)},setCursor=function(el,pos){pos=pos?pos:0;var range=rangy.createRange();range.setStart(el?el.childNodes[0]:edit[0].childNodes[0],pos),range.collapse(!0);var sel=rangy.getSelection();sel.setSingleRange(range)},setFocus=function(el){if(edit.find(".active").removeClass("active"),$(el).is("p"))return selectedElement=el,selectedElement.addClass("active"),!1;var node=window.getSelection().focusNode;oldSelectedElement=selectedElement,node&&!$(node).is("p")&&(node=node.parentNode),selectedElement=$(node),selectedElement.is("p")||(selectedElement=selectedElement.parents("p")),selectedElement&&selectedElement.addClass("active")},toggleDone=function(e){var that=$(this);e&&(e.preventDefault(),e.stopImmediatePropagation(),e.stopPropagation());var isSelected,val=that.text(),checked=inArr(val+" ",_checkbox_ticked)?!0:!1,invalid=inArr(val+" ",_checkbox_invalid)?!0:!1,parent=that.parents("p");selectedElement[0]===parent[0]&&(isSelected=!0),save(selectedElement[0]),that.replaceWith(checked||invalid?tick:tock);var newP;if(checked||invalid){var str;checked&&(str=parent.text().replace(/#done+(.*?)\((.*?)\)+|#done/g,"")),invalid&&(str=parent.text().replace(/#done+(.*?)\((.*?)\)+|#done| #invalid/g,"")),newP=$("<p>"+str+"</p>"),parent.replaceWith(newP)}else{var date=options.appendDate.value?moment().format("(MMM,Do HH:mm)"):"";newP=$("<p>"+$.trim(parent.text())+" #done "+date+"</p>"),parent.replaceWith(newP)}restore(isSelected?newP[0]:selectedElement[0]),formatLine(newP),setFocus(),extractTags()},setDefault=function(){edit.html(_default),setCursor()},updateFileList=function(_files){var html="",selectedKey=App[adapter].getCurrentFileID();for(var key in _files){var title=trimmedTitle(_files[key].text||"");html+='<div class="file '+(key===selectedKey?"active":"")+'" data-id="'+key+'"><span>'+title+'</span><div class="trash"></div></div>'}files.html(html)},updateFileListItem=function(text){var title=trimmedTitle(text);files.find(".file.active").find("span").text(title)},trimmedTitle=function(value){var title=$.trim(value.split("\n")[0]);return title=title.length>25?title.substr(0,25):title,title||"..."},logout=function(){App.cloud.logout(setUser)};return{init:init,setAndParse:setAndParse,updateFileList:updateFileList,updateFileListItem:updateFileListItem,setUser:setUser,trimmedTitle:trimmedTitle,logout:logout,options:options}}(),App.api=function(){var xhr,urls={},get=function(type,data,success,error){var url=urls[type];xhr=$.ajax({url:url,data:data,dataType:"jsonp",type:"GET",contentType:"application/json",cache:!1,timeout:15e3,success:function(data){success&&success(data)},error:function(data){"timeout"===data.statusText?console.log("Connection timed out."):"abort"!==data.statusText&&console.log("Connection error!"),error&&error(data)}})},abort=function(){xhr&&4!==xhr.readyState&&xhr.abort()};return{get:get,abort:abort}}(),App.storage=function(){var edit,index,_files,loadTrigger,init=function(){edit=$("#edit"),localforage.config({driver:localforage.WEBSQL,name:"Cleared",version:1,size:4980736,storeName:"todolist",description:"Files stored in Cleared.io"})},clear=function(){localforage.clear(),loadTrigger=null,_files={},index=null},save=function(value,title,callback){console.log("saving"),value&&(_files[index].text=value||"",_files[index].title=title||"",_files[index].date=(new Date).getTime()),localforage.setItem("files",_files),callback&&callback()},getCurrentFileID=function(){return index},get=function(){return _files},guid=function(){return Math.random().toString(36).substring(7)},add=function(callback,text,id){var file={text:text||"",date:(new Date).getTime()},uid=id||guid();_files[uid]=file,save(null,"",function(){load(function(_files){loadTrigger(_files),id||callback(uid)})})},remove=function(id,callback){delete _files[id],save(null,function(){load(function(_files){loadTrigger(_files),id||callback(uid)})})},open=function(id,callback){index=id,console.log("open:"+id),callback(_files[id])},load=function(callback){loadTrigger||(loadTrigger=callback),localforage.getItem("files",function(err,value){_files=value||{},Object.size(_files)?(console.log("loaded"),callback(_files)):(console.log("Loading default..."),$.ajax({url:"default.txt",dataType:"text",success:function(data){index=null,console.log("loaded default"),add(callback,data,"intro")}}))})};return{init:init,clear:clear,save:save,load:load,get:get,add:add,remove:remove,getCurrentFileID:getCurrentFileID,open:open}}(),App.cloud=function(){var firebase,auth,users,user,files,file,init=function(){firebase=new Firebase("https://cleared.firebaseio.com/"),users=firebase.child("users"),files=firebase.child("files"),firebase.onAuth(authCallback)},authCallback=function(authData){authData?(auth=authData,user=users.child(authData.uid),console.log(authData),console.log("User "+authData.uid+" is logged in with "+authData.provider)):(auth=null,file=null,user=null,console.log("User is logged out")),user&&migrate(),App.view.setUser(auth)},add=function(callback,data){var obj={date:Firebase.ServerValue.TIMESTAMP,text:data?data.text||"":"",users:{}};obj.users[auth.uid]=!0,file=files.push(obj,function(){user.child("files").child(file.key()).set({text:data?data.title||"":""},function(){callback(file.key())})})},load=function(callback){user.child("files").on("value",function(snapshot){callback(snapshot.val(),file?file.key():null)})},getCurrentFileID=function(){return file?file.key():null},open=function(value,callback){file=files.child(value),file.once("value",function(snapshot){console.log("file triggered"),callback(snapshot.val())})},save=function(value,title){Firebase.ServerValue.TIMESTAMP;file.update({text:value,date:Firebase.ServerValue.TIMESTAMP}),user.child("files").child(file.key()).update({text:title})},remove=function(id,callback){var key=file.key();file.remove(callback),user.child("files").child(key).remove()},migrate=function(){var _files=App.storage.get();for(var key in _files)"intro"!==key&&add({},_files[key]);App.storage.clear()},login=function(){firebase.authWithOAuthPopup("google",function(error,authData){error?console.log("Login Failed!",error):users.child(authData.uid).once("value",function(dataSnapshot){var userExists=dataSnapshot.exists();userExists?console.log("Successfully signed in"):(console.log("no user"),users.child(authData.uid).set({provider:authData.provider,name:authData.google.displayName},function(){}),console.log("Successfully signed up"))})})},logout=function(){firebase.unauth()};return{init:init,login:login,logout:logout,add:add,save:save,remove:remove,load:load,getCurrentFileID:getCurrentFileID,open:open}}();var ready=function(){head.js.apply(window,scripts).ready("autolink",function(){checkDevice(),App.view.init()})};window.cordova?document.addEventListener("deviceready",ready,!1):ready(),window.console=window.console||{log:function(){}};var checkDevice=function(){device.desktop()?(event_down="mousedown",event_move="mousemove",event_release="mouseup"):(event_down="touchstart",event_move="touchmove",event_release="touchend")};Object.size=function(obj){var key,size=0;for(key in obj)obj.hasOwnProperty(key)&&size++;return size};var savedSel=null,savedSelActiveElement=null,Data=function(){var warehouse={},count=1;return{reset:function(){count=1,warehouse={}},set:function(dom,data){dom.__data||(dom.__data="hello"+count++),warehouse[dom.__data]=data},get:function(dom){return warehouse[dom.__data]}}}();!function(){for(var lastTime=0,vendors=["webkit","moz"],x=0;x<vendors.length&&!window.requestAnimationFrame;++x)window.requestAnimationFrame=window[vendors[x]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[vendors[x]+"CancelAnimationFrame"]||window[vendors[x]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(callback){var currTime=(new Date).getTime(),timeToCall=Math.max(0,16-(currTime-lastTime)),id=window.setTimeout(function(){callback(currTime+timeToCall)},timeToCall);return lastTime=currTime+timeToCall,id}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(id){clearTimeout(id)})}();