/*! DO NOT EDIT THIS FILE */
/*! File Minified by grunt @ 2015-02-03 20:49 */
/*!
 * DO NOT EDIT THIS FILE
 * File concatatenated by grunt @ 2015-02-03 20:49
 * HeadStart
 * 
 * 
 * @author Nic Mulvaney
 * @version 0.0.1
 * Copyright 2013. MIT licensed.
 */


function save(el,offset){el||document.getElementById("edit");savedSelection=saveSelection(el||document.getElementById("edit"),offset)}function restore(el,offset){savedSelection&&restoreSelection(el||document.getElementById("edit"),savedSelection,offset)}function saveSelection(){if(window.getSelection){if(sel=window.getSelection(),sel.getRangeAt&&sel.rangeCount)return sel.getRangeAt(0)}else if(document.selection&&document.selection.createRange)return document.selection.createRange();return null}function restoreSelection(range){range&&(window.getSelection?(sel=window.getSelection(),sel.removeAllRanges(),sel.addRange(range)):document.selection&&range.select&&range.select())}function setCursorToEnd(ele){var range=document.createRange(),sel=window.getSelection();range.setStart(ele,1),range.collapse(!0),sel.removeAllRanges(),sel.addRange(range),ele.focus()}function cancelEvent(e){return isInFocus===!1&&null!==savedRange?(e&&e.preventDefault?(e.stopPropagation(),e.preventDefault()):window.event.cancelBubble=!0,restoreSelection(),!1):void 0}var App=App||{},scripts=[{jquery:"js/vendor/jquery-2.1.3.min.js"},{device:"js/vendor/device.min.js"},{moment:"js/vendor/moment.min.js"},{storage:"js/vendor/localforage.min.js"},{transparency:"js/vendor/transparency.min.js"}],event_down,event_move,event_release,transition="transitionend webkitTransitionEnd",animation="animationend webkitAnimationEnd";App.view=function(){function p(t){return t=t.trim(),t.length>0?"<p>"+t.replace(/\r?\n/g,"</p><p>")+"</p>":null}var area,input,debug,li,but,space,curtain,selectedElement,currentKey,tick='<span class="mark tick">☐</span>',tock='<span class="mark tick">☑</span>',invalid='<span class="mark invalid">☒</span>',init=function(){console.log("All ready!"),App.storage.init(),area=$("#area"),edit=$("#edit"),debug=$("#debug"),input=$("#area2 .text"),li=$("<li/>"),but=$("<div class='but' />")[0],space=$("<div class='space' />")[0],curtain=$(".curtain"),actions()},parseTags=function(str){var tags={},newStr=str.replace(/[#]+[A-Za-z0-9-_():,/]+/g,function(u){var name=u.slice(1).split("(")[0];return tags[name]=!0,"<span class='tag' data-id='"+name+"'>"+u+"</span>"});return{str:newStr,tags:tags}},parseUsernames=function(str){var users={},newStr=str.replace(/[@]+[A-Za-z0-9-_():,/]+/g,function(u){var name=u.slice(1).split("(")[0];return users[name]=!0,"<span class='username' data-id='"+name+"'>"+u+"</span>"});return{str:newStr,users:users}},parseTodo=function(str,tags,el){var isList,start=str.slice(0,2);if(el.removeClass("todo done invalid"),"- "===start||"☐ "===start||"☑ "===start||"☒ "===start){var tickEl=tick;str.length>=2&&(el.addClass("todo"),tickEl=tick),tags.done&&(el.addClass("done"),tickEl=tock),tags.invalid&&(el.addClass("invalid"),tickEl=invalid),str=tickEl+" "+str.slice(2),isList=!0}return{text:str,todo:isList}},parseTitles=function(str,el){var end=str.slice(-1);return el.removeClass("title"),":"===end&&el.addClass("title"),{str:str}},shortcuts={68:function(){selectedElement.find(".mark").trigger(event_down)}},actions=function(){edit.on("keydown",function(e){currentKey={keyCode:e.keyCode,altKey:e.altKey,ctrlKey:e.ctrlKey,metaKey:e.metaKey,shiftKey:e.shiftKey},currentKey.metaKey&&shortcuts[currentKey.keyCode]&&(shortcuts[currentKey.keyCode](),e.preventDefault()),requestAnimationFrame(function(){setFocus()})}).on("keyup",function(){currentKey=null,setFocus()}),document.onmouseup=setFocus,edit.on(event_down,".mark",toggle),edit.on("DOMSubtreeModified","p",formatLine),App.storage.load(),edit.on("input",function(){App.storage.save()}),edit[0].addEventListener("paste",function(e){e.preventDefault();var text=e.clipboardData.getData("text/plain");text=p(text).replace("<p></p>","").replace("<p><br></p>",""),document.execCommand("insertHTML",!1,text),setAndParse(null,!0)})},setAndParse=function(value,nofocus){nofocus||edit.focus(),value&&(save(),edit.html(value),restore()),edit.find("p").trigger("DOMSubtreeModified"),setCursorToEnd(edit.find("p").last()[0])},setFocus=function(){edit.find(".active").removeClass("active"),selectedElement=window.getSelection().focusNode.parentNode;var anchor=window.getSelection().anchorNode;"<br>"===anchor.innerHTML&&(selectedElement=anchor),selectedElement=$(selectedElement),selectedElement.is("p")||(selectedElement=selectedElement.parents("p")),selectedElement.addClass("active")},toggle=function(e){var that=$(this);e&&(e.preventDefault(),e.stopPropagation());var val=that.text(),checked="☑"===val?!0:!1,invalid="☒"===val?!0:!1,parent=that.parents("p");save(),parent[0].modifying=!0,that.replaceWith(checked||invalid?tick:tock),parent[0].modifying=!1,parent.toggleClass("done",checked),parent.toggleClass("invalid",invalid);var newP;if(checked||invalid){var str;checked&&(str=parent.text().replace(/ #done+[A-Za-z0-9-_():,]+| #done/g,"")),invalid&&(str=parent.text().replace(/ #done+[A-Za-z0-9-_():,]+| #invalid/g,"")),newP=$("<p>"+str+"</p>"),newP[0].modifying=!1,parent.replaceWith(newP)}else{{moment().format("MMM,Do-hh:mm")}newP=$("<p>"+parent.text()+" #done</p>"),newP[0].modifying=!1,parent.replaceWith(newP)}restore(),requestAnimationFrame(function(){newP.trigger("DOMSubtreeModified")}),App.storage.save()},formatLine=function(e){{var el=$(e.currentTarget);el.next()}if(el[0].modifying)return!1;beginModify(el);var text=el.text(),titles=parseTitles(text,el),tags=parseTags(titles.str),usernames=parseUsernames(tags.str),todo=parseTodo(usernames.str,tags.tags,el),newText=todo.text,tagStr=tags.tags.join(" ");return console.log(tagStr),newText?(el.html(newText),endModify(el),!1):(el.html("<br/>"),el[0].modifying=!1,endModify(el),void(currentKey?currentKey.metaKey&&86===currentKey.keyCode||setCursorToEnd(el[0]):setCursorToEnd(el[0])))},beginModify=function(el){el[0].modifying=!0,save()},endModify=function(el){restore(),el[0].modifying=!1};return{init:init,setAndParse:setAndParse}}(),App.api=function(){var xhr,urls={},get=function(type,data,success,error){var url=urls[type];xhr=$.ajax({url:url,data:data,dataType:"jsonp",type:"GET",contentType:"application/json",cache:!1,timeout:15e3,success:function(data){success&&success(data)},error:function(data){"timeout"===data.statusText?console.log("Connection timed out."):"abort"!==data.statusText&&console.log("Connection error!"),error&&error(data)}})},abort=function(){xhr&&4!==xhr.readyState&&xhr.abort()};return{get:get,abort:abort}}(),App.storage=function(){var edit,init=function(){edit=$("#edit")},save=function(){var value=edit.html();localforage.setItem("page",value)},load=function(){localforage.getItem("page",function(err,value){App.view.setAndParse(value)})};return{init:init,save:save,load:load}}();var ready=function(){head.js.apply(window,scripts).ready("transparency",function(){checkDevice(),App.view.init()})};window.cordova?document.addEventListener("deviceready",ready,!1):ready(),window.console=window.console||{log:function(){}};var checkDevice=function(){device.desktop()?(event_down="mousedown",event_move="mousemove",event_release="mouseup"):(event_down="touchstart",event_move="touchmove",event_release="touchend")},saveSelection,restoreSelection;window.getSelection&&document.createRange?(saveSelection=function(containerEl,offset){offset=offset?offset:0;var range=window.getSelection().getRangeAt(0),preSelectionRange=range.cloneRange();preSelectionRange.selectNodeContents(containerEl),preSelectionRange.setEnd(range.startContainer,range.startOffset);var start=preSelectionRange.toString().length+offset;return{start:start,end:start+range.toString().length}},restoreSelection=function(containerEl,savedSel,offset){offset=offset?offset:0;var charIndex=0,range=document.createRange();range.setStart(containerEl,0),range.collapse(!0);for(var node,nodeStack=[containerEl],foundStart=!1,stop=!1;!stop&&(node=nodeStack.pop());)if(3===node.nodeType){var nextCharIndex=charIndex+node.length;!foundStart&&savedSel.start>=charIndex&&savedSel.start<=nextCharIndex&&(range.setStart(node,savedSel.start-charIndex),foundStart=!0),foundStart&&savedSel.end>=charIndex&&savedSel.end<=nextCharIndex&&(range.setEnd(node,savedSel.end-charIndex),stop=!0),charIndex=nextCharIndex}else for(var i=node.childNodes.length;i--;)nodeStack.push(node.childNodes[i]);var sel=window.getSelection();sel.removeAllRanges(),sel.addRange(range)}):document.selection&&document.body.createTextRange&&(saveSelection=function(containerEl){var selectedTextRange=document.selection.createRange(),preSelectionTextRange=document.body.createTextRange();preSelectionTextRange.moveToElementText(containerEl),preSelectionTextRange.setEndPoint("EndToStart",selectedTextRange);var start=preSelectionTextRange.text.length;return{start:start,end:start+selectedTextRange.text.length}},restoreSelection=function(containerEl,savedSel){var textRange=document.body.createTextRange();textRange.moveToElementText(containerEl),textRange.collapse(!0),textRange.moveEnd("character",savedSel.end),textRange.moveStart("character",savedSel.start),textRange.select()});var savedSelection,Data=function(){var warehouse={},count=1;return{reset:function(){count=1,warehouse={}},set:function(dom,data){dom.__data||(dom.__data="hello"+count++),warehouse[dom.__data]=data},get:function(dom){return warehouse[dom.__data]}}}();!function(){for(var lastTime=0,vendors=["webkit","moz"],x=0;x<vendors.length&&!window.requestAnimationFrame;++x)window.requestAnimationFrame=window[vendors[x]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[vendors[x]+"CancelAnimationFrame"]||window[vendors[x]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(callback){var currTime=(new Date).getTime(),timeToCall=Math.max(0,16-(currTime-lastTime)),id=window.setTimeout(function(){callback(currTime+timeToCall)},timeToCall);return lastTime=currTime+timeToCall,id}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(id){clearTimeout(id)})}();