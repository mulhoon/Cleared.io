/*!
 * DO NOT EDIT THIS FILE
 * File concatatenated by grunt @ 2015-03-09 13:55
 * Cleared.io
 * 
 * 
 * @author Nic Mulvaney
 * @version 0.0.1
 * Copyright 2015. MIT licensed.
 */


function save(el){return savedSel=rangy.getSelection().saveCharacterRanges(el)}function restore(el,offset,selection){selection&&(savedSel=selection),offset&&(savedSel[0].characterRange.start+=offset,savedSel[0].characterRange.end+=offset),rangy.getSelection().restoreCharacterRanges(el,savedSel)}function guid(){return Math.random().toString(36).substring(7)}function getByID(arr,id){var elementPos=arr.map(function(e){return e.key}).indexOf(id);return elementPos}function reverseForIn(obj,f){var arr=[];for(var key in obj)arr.push(key);for(var i=arr.length-1;i>=0;i--)f.call(obj,arr[i])}var App=App||{},scripts=[{jquery:"js/vendor/jquery-2.1.3.min.js"},{riotjs:"js/vendor/riot.js"},{device:"js/vendor/device.min.js"},{moment:"js/vendor/moment.min.js"},{chosen:"js/vendor/chosen.jquery.min.js"},{rangycore:"js/vendor/rangy/rangy-core.js"},{rangytextrange:"js/vendor/rangy/rangy-textrange.js"},{undo:"js/vendor/undomanager.js"},{storage:"js/vendor/localforage.min.js"},{switchery:"js/vendor/switchery.min.js"},{fastclick:"js/vendor/fastclick.js"},{hammer:"js/vendor/hammer.min.js"},{nobounce:"js/vendor/inobounce.min.js"},{firebase:"js/vendor/firebase.js"},{textcomplete:"js/vendor/jquery.textcomplete.min.js"},{autolink:"js/vendor/ba-linkify.min.js"}],event_down,event_move,event_release,transition="transitionend webkitTransitionEnd",animation="animationend webkitAnimationEnd";App.view=function(){var body,selectedElement,sidebar,newfile,files,style,saveTimer,undoManager,oldhtml,oldcursor,opening,_filtered,_filter,keyboardTimer,currentKey={keyCode:null},adapter="storage",options={saveDelay:{value:300},appendDate:{value:!0,name:"Append date to <span class='tag' data-id='#done'>#done</span>",visible:!0},spellcheck:{value:!0,name:"Spell check",visible:!0,func:function(value){edit[0].spellcheck=value,edit[0].focus(),edit[0].blur()}},smallfont:{value:!1,name:"Use small font",visible:!0,func:function(value){value?body.css({"font-size":"15px"}):body.attr("style","")}}},shortcuts={68:function(){selectedElement.find(".mark").trigger(event_down)},38:function(){moveItem(-1)},40:function(){moveItem(1)}},_checkbox=["☐","-","*","-[ ]"],_checkbox_ticked=["☑","✔"],_checkbox_invalid=["☒","✘"],_all=_checkbox.concat(_checkbox_ticked).concat(_checkbox_invalid),_default="<p><br/></p>",tick='<span class="mark tick">'+_checkbox[0]+"</span>",tock='<span class="mark tock">'+_checkbox_ticked[0]+"</span>",invalid='<span class="mark invalid">'+_checkbox_invalid[0]+"</span>",init=function(){body=$("body"),style=$("#style"),edit=$("#edit"),sidebar=$("#sidebar"),files=$("#files"),newfile=$(".newfile-button"),settingbut=$(".setting-button"),search=$("#search input"),signin=$("#signin-google"),selectedElement=$("<div/>"),riotMenu(),App.storage.init(),App.cloud.init(),actions(),rangy.init(),$(".chosen").chosen().change(runSearch),undoManager=new UndoManager,settings(),FastClick.attach(document.body),typed()},typed=function(){$(".typeahead").textcomplete([{match:/(^|\s)@(\w{2,})$/,search:function(term,callback){console.log(term),callback($.map(friends,function(e){return 0===e.username.indexOf(term)?e.username:null}))},replace:function(word){return word+" "}}],{}).on({"textComplete:select":function(e,value){var elementPos=friends.map(function(e){return e.username}).indexOf(value),friend=friends[elementPos];App[adapter].addSharer(friend)}}).on("focus",function(){$(this).val("@")}).on("blur",function(){$(this).val(""),window.scrollTo(0,0)})},removeSharer=function(e){App[adapter].removeSharer(e.item)},setUser=function(user){user?($(".user").html("signed in as "+user[user.provider].displayName+' <a href="#logout">sign out</a>').show(),signin.hide(),adapter="cloud"):($(".user").text("").hide(),signin.show(),adapter="storage"),App[adapter].load()},settings=function(){var html="";for(var key in options){var a=options[key];a.visible&&(html+='<div class="row">'+a.name+'<input type="checkbox" id="'+key+'" class="js-switch" '+(a.value?"checked":"")+' /><div class="clear"></div></div>')}$(".settings .middle").html(html);var switches=$(".settings input");switches.each(function(i,a){new Switchery(a,{size:"small",color:"#3D9970"});a.onchange=function(){var id=$(this).attr("id");options[id].value=this.checked,options[id].func&&options[id].func(this.checked)}})},addUndo=function(attrs){undoManager.add({undo:function(){edit.html(attrs.oldhtml),extractTags(),requestAnimationFrame(function(){restore(edit[0],0,attrs.oldcursor)})},redo:function(){edit.html(attrs.html),extractTags(),requestAnimationFrame(function(){restore(edit[0],0,attrs.cursor)})}})},parseTags=function(str,type,identifier,identifierEnd){var tags={},tagString=[];identifierEnd=identifierEnd?"+["+identifierEnd+"]":"";var reg=new RegExp("\\B["+identifier+"]([\\w-]+)"+identifierEnd,"g"),html=str.replace(reg,function(u){var name=u.slice(1).split("(")[0];return tags[name]=tags[name]||{count:0},tags[name].name=name,tags[name].id=identifier+name,tags[name].html="<span class='"+type+"' data-id='"+identifier+name+"'>"+u+"</span>",tags[name].count++,tags[name].html});for(var tag in tags)tagString.push(identifier+tag);return tagString=tagString.join(" "),{type:type,html:html,tags:tags,tagString:tagString}},parseLinks=function(str){return{html:linkify(str)}},inArr=function(value,arr){for(var i=0;i<arr.length;i++)if(value===arr[i]+" ")return!0;return!1},parseTodo=function(str,tags){var classStr="",start=str.slice(0,2);if(inArr(start,_all)){var tickEl="";str.length>=2&&(tickEl=tick),tags&&(tags.done&&(tickEl=tock),tags.invalid&&(tickEl=invalid)),str=tickEl+" "+str.slice(2),classStr="todo"}return{html:str,todo:classStr}},parseTitles=function(str){var end=str.slice(-1);return{html:str,classStr:":"===end?" title":""}},actions=function(){document.delayFocus=function(){requestAnimationFrame(function(){setFocus()})};var mc=new Hammer(body[0],{velocity:.9});mc.on("swiperight",function(){body.addClass("showMenu")}).on("swipeleft",function(){body.removeClass("showMenu")}),edit.on(click,"p",function(){setFocus($(this))}),edit.on(event_release,"p",function(){requestAnimationFrame(function(){setFocus()})}),edit.on(event_down,".mark",toggleDone),body.on(click,"a",openURL);edit.on("input",function(){var value=edit.html();return value?(edit.removeClass("empty"),opening?!1:(setFocus(),selectedElement&&formatLine(),void saveFile())):(setDefault(),!1)}).on(event_down,function(){}).on("focus",function(){bindEditKeyActions(!0),iNoBounce.disable()}).on("blur",function(){iNoBounce.enable(),bindEditKeyActions(!1)}),edit[0].addEventListener("copy",copy),edit[0].addEventListener("paste",paste),newfile.on(click,function(){var newObj={text:"",active:!0,key:"new"};App.view.items.unshift(newObj),open({item:newObj}),body.removeClass("showMenu")}),settingbut.on(click,function(){body.toggleClass("settings")}),signin.on(click,App.cloud.login),$(".close, .menu, .cover").on(click,function(){body.hasClass("settings")||body.hasClass("info")?body.removeClass("settings info"):body.toggleClass("showMenu")}),$(".cover").on(click,function(){body.removeClass("settings info showMenu")}),window.addEventListener("scroll",function(){$(".page").scrollTo(0,0)},!1)},bindEditKeyActions=function(value){var wtop;value?($(window).on("keydown",editKeyActions).on("keyup",function(){currentKey={keyCode:null}}),body.addClass("editing"),keyboardTimer=setTimeout(function(){if(body.hasClass("editing")){var top=$(".page").scrollTop();wtop=$(window).scrollTop(),body.addClass("keyboard"),$(".page").scrollTop(0),window.scrollTo(0,wtop+top)}},600)):(clearTimeout(keyboardTimer),$(window).off("keydown").off("keyup"),wtop=$(window).scrollTop(),body.removeClass("editing keyboard"),$(".page").scrollTop(wtop),window.scrollTo(0,0))},editKeyActions=function(e){if(currentKey={keyCode:e.keyCode,altKey:e.altKey,ctrlKey:e.ctrlKey,metaKey:e.metaKey,shiftKey:e.shiftKey},currentKey.metaKey&&shortcuts[currentKey.keyCode])return shortcuts[currentKey.keyCode](),void e.preventDefault();var selection,start,end;if(13===e.keyCode){selection=save(selectedElement[0])[0].characterRange,start=selection.start,end=selection.end;var text=selectedElement.text(),pos=text.length,newStr=text.substr(end,pos-end),oldStr=text.substr(0,start),cursorOffest=0,isTodo=selectedElement.hasClass("todo"),isTitle=selectedElement.hasClass("title"),isEnd=end===pos,isStart=0===start,additions=newStr;isTodo&&!parseTodo(newStr).todo&&(additions="- "+additions,cursorOffest=2),(!text||isTodo||isTitle&&!isEnd)&&selectedElement.attr("class","").removeAttr("data-id data-children");var parentTitle=isTitle?selectedElement:selectedElement.prevAll(".title").eq(0),parentTags=$.trim(parentTitle.attr("data-id"));if(parentTags&&(additions+=" "+parentTags),_filtered&&(additions+=" "+_filter),$.trim(oldStr)===_checkbox[0])return newStr=newStr?newStr:"<br/>",selectedElement.html(newStr).removeClass("todo"),setCursor(selectedElement[0]),e.preventDefault(),saveFile(!0),void document.delayFocus();if(isTodo&&!isStart||isTitle&&!isEnd&&!isStart||parentTags||_filtered){newStr=additions,newStr=newStr?newStr:"<br/>",selectedElement.text(oldStr),formatLine();var newP=$("<p>"+newStr+"</p>");return newP.insertAfter(selectedElement),setCursor(newP[0],cursorOffest),setFocus(),formatLine(newP),saveFile(!0),document.delayFocus(),void e.preventDefault()}}if(40===e.keyCode){selection=save(selectedElement[0]);var len=selectedElement.next().text().length;return selection[0].characterRange.start>len&&(selection[0].characterRange.start=len,selection[0].characterRange.end=len),restore(selectedElement.next()[0],0,selection),document.delayFocus(),void e.preventDefault()}document.delayFocus(),e.metaKey&&90===e.keyCode&&(e.shiftKey&&e.metaKey&&90===e.keyCode?undoManager.hasRedo()&&undoManager.redo():e.metaKey&&90===e.keyCode&&undoManager.hasUndo()&&undoManager.undo())},saveFile=function(instant){clearTimeout(saveTimer),saveTimer=setTimeout(function(){extractTags();var html=edit.html(),cursor=save(edit[0]);if(html!==oldhtml){addUndo({oldhtml:oldhtml,html:html,oldcursor:oldcursor,cursor:cursor});var txt=getAllText();App[adapter].save(txt),App.storage.saveLocalCopy(txt)}oldhtml=html,oldcursor=cursor},instant?0:options.saveDelay.value)},showInfo=function(){body.addClass("info")},hideInfo=function(){body.removeClass("info")},copy=function(){},paste=function(e){e.preventDefault();var selection=save(edit[0])[0].characterRange,text=(selection.start,selection.end,e.clipboardData.getData("text/plain"));text=p(text),document.execCommand("insertHTML",!1,text),opening=!0,edit.find("p").each(function(i,a){formatLine($(a))}),opening=!1},openURL=function(e){var url=$(this).attr("href");"#"===url.slice(0,1)?App.view[url.slice(1)]():window.open(url,"_blank"),e.preventDefault(),e.stopPropagation()},runSearch=function(){var chosen=$(".chosen option:selected"),value=[];$(chosen).each(function(){value.push($(this).attr("value"))}),value=value?value.join(" "):"";var tags=parseTags(value,"tag","#"),mentions=parseTags(value,"mention","@");filterPage($.extend(tags.tags,mentions.tags))},p=function(t){return t=$.trim(t),(t.length>0?"<p>"+t.replace(/\r?\n/g,"</p><p>")+"</p>":"").replace(/<p><\/p> | <p><br><\/p>/g,"")},moveItem=function(direction){save(selectedElement[0]),1===direction?selectedElement.insertAfter(selectedElement.next()):selectedElement.insertBefore(selectedElement.prev()),restore(selectedElement[0]),selectedElement.addClass("blink").on(animation,function(){$(this).removeClass("blink")})},formatLine=function(node){var container=node||selectedElement,text=(container.prev(),container.text()),titles=parseTitles(text),highlight=parseTags(titles.html,"highlight","*","*"),tags=parseTags(highlight.html,"tag","#"),mentions=parseTags(tags.html,"mention","@"),links=parseLinks(mentions.html),todo=parseTodo(links.html,tags.tags),newText=todo.html,attr=tags.tagString+" "+mentions.tagString;newText=newText?newText:"<br/>",opening||save(container[0]),container.html(newText).attr("class",titles.classStr+todo.todo).attr("data-id",attr),opening||restore(container[0])},getAllText=function(){return edit[0].innerText},parseAll=function(){var groupTitle,oldNode,gt,nodes=edit.find("p"),text=(nodes.length,""),tagStr="";return nodes.each(function(i,a){var node=$(a),classList=node[0].classList,isTitle=classList.contains("title");groupTitle=isTitle?node:groupTitle,groupTitle!==oldNode&&(tagStr="",gt=groupTitle),text+=node.text()+"\n",isTitle||(tagStr+=node.attr("data-id")+" "),gt&&gt.attr("data-children",$.trim(tagStr)),oldNode=groupTitle}),text},addSearchOptions=function(options){if($.isEmptyObject(options[0].tags)&&$.isEmptyObject(options[1].tags))return void $("#search").hide();var filters,html="";filters=_filtered?_filter.split(" "):[];for(var group in options){html+='<optgroup label="'+options[group].group+'">';for(var key in options[group].tags){var tag=options[group].tags[key].id;html+="<option value="+tag+' data-type="file" ',html+=-1!==$.inArray(tag,filters)?"selected":"",html+=">"+tag+"</option>"}html+="</optgroup>"}$(".chosen").html(html).trigger("chosen:updated")},extractTags=function(){var text=parseAll(),tags=parseTags(text,"tag","#").tags,mentions=parseTags(text,"mention","@").tags;addSearchOptions([{group:"Tags",tags:tags},{group:"Mentions",tags:mentions}])},filterPage=function(items){var html="#edit p{display:none;} ",htmlTags="#edit p",htmlTitles="#edit p";_filter="";for(var key in items){var tag=items[key].id;htmlTags+='[data-id~="'+tag+'"]',htmlTitles+='[data-children~="'+tag+'"]',_filter+=tag+" "}html+=htmlTags+","+htmlTitles+"{display:block;}\n",style.html(html),_filtered=!0},setAndParse=function(file,clear,restoreCursor){if(!file)return!1;var value=file.text,currentValue=getAllText();if(value===currentValue)return void console.log("updateCancelled");style.html(""),$(".chosen").val("").trigger("chosen:updated");var text,isReset;edit.removeClass("empty"),$.trim(value).length||edit.addClass("empty"),value?(text=p(value),isReset=!1):(text=_default,isReset=!0),opening=!0,restoreCursor&&save(edit[0]),edit.html(text),edit.find("p").each(function(i,a){formatLine($(a))}),restoreCursor&&restore(edit[0]),selectedElement=edit.find("p").eq(0),opening=!1,oldhtml=edit.html(),isReset&&(oldcursor=save(edit[0])),setTimeout(function(){!isReset||clear||restoreCursor||setCursor(),clear||extractTags()},1),App.storage.saveLocalCopy(value)},setCursor=function(el,pos){pos=pos?pos:0;var range=rangy.createRange();range.setStart(el?el.childNodes[0]:edit[0].childNodes[0],pos),range.collapse(!0);var sel=rangy.getSelection();sel.setSingleRange(range)},setFocus=function(el){if(edit.find(".active").removeClass("active"),$(el).is("p"))return selectedElement=el,selectedElement.addClass("active"),!1;var node=window.getSelection().focusNode;oldSelectedElement=selectedElement,node&&!$(node).is("p")&&(node=node.parentNode),selectedElement=$(node),selectedElement.is("p")||(selectedElement=selectedElement.parents("p")),selectedElement&&selectedElement.addClass("active")},toggleDone=function(e){var that=$(this);e&&(e.preventDefault(),e.stopImmediatePropagation(),e.stopPropagation());var isSelected,val=that.text(),checked=inArr(val+" ",_checkbox_ticked)?!0:!1,invalid=inArr(val+" ",_checkbox_invalid)?!0:!1,parent=that.parents("p");selectedElement[0]===parent[0]&&(isSelected=!0),save(selectedElement[0]),that.replaceWith(checked||invalid?tick:tock);var newP;if(checked||invalid){var str;checked&&(str=parent.text().replace(/#done+(.*?)\((.*?)\)+|#done/g,"")),invalid&&(str=parent.text().replace(/#done+(.*?)\((.*?)\)+|#done| #invalid/g,"")),newP=$("<p>"+str+"</p>"),parent.replaceWith(newP)}else{var date=options.appendDate.value?moment().format("(MMM,Do HH:mm)"):"";newP=$("<p>"+$.trim(parent.text())+" #done "+date+"</p>"),parent.replaceWith(newP)}restore(isSelected?newP[0]:selectedElement[0]),formatLine(newP),setFocus(),saveFile(!0)},setDefault=function(){edit.html(_default),edit.addClass("empty"),setCursor()},riotMenu=function(){riot.mount("files"),riot.mount("shared"),riot.mount("info"),riot.mount("sharedsmall")};this.items=[],this.currentItem=null,this.friends=[],this.lastOpened=null;var open=function(e){var item=e.item;App.view.currentItem&&(App.view.currentItem.active=!1);for(var i=0;i<App.view.items.length;i++)App.view.items[i].active=!1;item.active=!0,riot.update(),App.view.currentItem=item,App[adapter].open(item.key),App[adapter].getSharers(item.key),App.storage.saveLastOpened(item.key),window.scrollTo(0,0),$(".page").scrollTop(0),setAndParse(item),riot.update(),typed()},remove=function(e){body.removeClass("info"),setTimeout(function(){App[adapter].remove()},300),e.preventDefault(),e.stopPropagation()},info=function(e){showInfo(),e.preventDefault(),e.stopPropagation()},trimmedTitle=function(value){var title=$.trim(value.split("\n",1)[0]);return title=title.length>25?title.substr(0,25):title,title||"..."},logout=function(){App.cloud.logout(setUser)};return{init:init,setAndParse:setAndParse,setUser:setUser,trimmedTitle:trimmedTitle,logout:logout,items:items,currentItem:currentItem,friends:friends,open:open,remove:remove,info:info,options:options,showInfo:showInfo,hideInfo:hideInfo,removeSharer:removeSharer,lastOpened:lastOpened,typed:typed}}(),App.api=function(){var xhr,urls={},get=function(type,data,success,error){var url=urls[type];xhr=$.ajax({url:url,data:data,dataType:"jsonp",type:"GET",contentType:"application/json",cache:!1,timeout:15e3,success:function(data){success&&success(data)},error:function(data){"timeout"===data.statusText?console.log("Connection timed out."):"abort"!==data.statusText&&console.log("Connection error!"),error&&error(data)}})},abort=function(){xhr&&4!==xhr.readyState&&xhr.abort()};return{get:get,abort:abort}}(),App.storage=function(){var edit,index,init=function(){edit=$("#edit"),localforage.config({driver:localforage.WEBSQL,name:"Cleared",version:1,size:4980736,storeName:"todolist",description:"Files stored in Cleared.io"}),getLastOpened()},clear=function(){localforage.setItem("files",null),index=null},save=function(value){console.log("saving"),console.log(index);var id=getByID(App.view.items,index),item=App.view.items[id];item&&("new"===item.key&&(App.view.items[id].key=guid(),index=App.view.items[id].key),value&&(App.view.items[id].text=value||"",App.view.items[id].date=(new Date).getTime())),localforage.setItem("files",App.view.items),riot.update()},getCurrentFileID=function(){return index},saveLastOpened=function(id){localforage.setItem("last",id)},saveLocalCopy=function(txt){localforage.setItem("localcopy",txt)},getLastOpened=function(){localforage.getItem("last",function(err,value){App.view.lastOpened=value}),localforage.getItem("localcopy",function(err,value){console.log("setandparse"),App.view.setAndParse({text:value})})},add=function(text,id){var file={text:text||"",date:(new Date).getTime(),active:!1,key:id||guid()};App.view.items.push(file),riot.update()},remove=function(){var pos=getByID(App.view.items,index);App.view.items.splice(pos,1),App.view.items[pos]?item=App.view.items[pos]:App.view.items[pos-1]?item=App.view.items[pos-1]:App.view.items[pos+1]&&(item=App.view.items[pos+1]),save(),item&&App.view.open({item:item})},open=function(key){index=key},load=function(){localforage.getItem("files",function(err,value){App.view.items=value||[],App.view.items.length?(App.view.items.sort(function(a,b){return b.date-b.date>=0?1:-1}),App.view.open({item:App.view.items[0]})):(console.log("Loading default..."),$.ajax({url:"default.txt",dataType:"text",success:function(data){index=null,console.log("loaded default"),add(data,"intro"),App.view.open({item:App.view.items[0]})}})),riot.update()})},getSharers=function(){};return{init:init,clear:clear,save:save,load:load,add:add,remove:remove,getCurrentFileID:getCurrentFileID,saveLastOpened:saveLastOpened,getSharers:getSharers,saveLocalCopy:saveLocalCopy,open:open}}(),App.cloud=function(){var firebase,auth,users,user,files,file,migrateItems;_files={};var shareWatch,shareWatchProfiles,init=function(){firebase=new Firebase("https://cleared.firebaseio.com/"),users=firebase.child("users"),files=firebase.child("files"),firebase.onAuth(authCallback)},authCallback=function(authData){authData?(auth=authData,auth.deviceID=guid(),user=users.child(authData.uid),App.view.items&&(migrateItems=JSON.parse(JSON.stringify(App.view.items))),App.view.items=[],updateUser(authData),getFriends(),console.log("User "+authData.uid+" is logged in with "+authData.provider)):(auth=null,file=null,user=null,console.log("User is logged out")),App.view.setUser(auth)},add=function(callback,data){var date=Firebase.ServerValue.TIMESTAMP,obj={date:date,text:data?data.text||"":"",users:{}};obj.users[auth.uid]=!0,file=files.push(obj,function(){var key=file.key(),userFile=user.child("files").child(key),pos=getByID(App.view.items,"new");-1!==pos&&(App.view.items[pos].key=key),userFile.setWithPriority(!0,date,callback)})},load=function(){(new Date).getTime();user.child("files").on("child_removed",function(snap){var pos=getByID(App.view.items,snap.key());if(-1!==pos){App.view.items.splice(pos,1);var item;App.view.items[pos]?item=App.view.items[pos]:App.view.items[pos-1]?item=App.view.items[pos-1]:App.view.items[pos+1]&&(item=App.view.items[pos+1]),item&&App.view.open({item:item})}});var opened,total=0,cached=0;user.child("files").orderByPriority().on("child_added",function(snap){var key=(snap.val(),snap.key());total++;-1===getByID(App.view.items,key);files.child(key).on("value",function(snaptitle){var key=snaptitle.key(),val=snaptitle.val();val.key=key;var pos=getByID(App.view.items,key);App.view.items[pos]?(val.active=App.view.items[pos].active,val.sharers=App.view.items[pos].sharers,App.view.items[pos]=val,key===App.view.currentItem.key&&(App.view.currentItem=App.view.items[pos],val.lastEditor!==auth.deviceID&&App.view.setAndParse(App.view.currentItem,null,!0))):(App.view.items.unshift(val),cached++,key===App.view.lastOpened?(App.view.open({item:val}),opened=!0):cached!==total||opened||App.view.open({item:App.view.items[0]})),riot.update()})},function(error){console.log("error"),console.log(error)})},getSharers=function(key){cleanup(),App.view.currentItem.sharers=[],shareWatch=files.child(key).child("users"),shareWatchProfiles=[],shareWatch.on("child_added",function(snap){var key=snap.key(),profile=users.child(key);shareWatchProfiles.push(profile),profile.on("value",function(userSnap){var val=userSnap.val();val.key=userSnap.key();var pos=getByID(App.view.currentItem.sharers,key);App.view.currentItem.sharers[pos]?App.view.currentItem.sharers[pos]=val:App.view.currentItem.sharers.unshift(val),riot.update()})}),shareWatch.on("child_removed",function(snap){var pos=getByID(App.view.currentItem.sharers,snap.key());-1!==pos&&App.view.currentItem.sharers.splice(pos,1)})},addSharer=function(friend){var user={};user[friend.key]=!0,shareWatch.update(user)},removeSharer=function(friend){console.log("remove friend"),shareWatch.child(friend.key).remove()},getFriends=function(){users.on("child_added",function(snap){var key=snap.key(),val=snap.val();val.key=key;var pos=getByID(App.view.friends,key);App.view.friends[pos]?App.view.friends[pos]=val:App.view.friends.push(val)})},cleanup=function(){if(shareWatch){shareWatch.off();for(var i=0;i>shareWatchProfiles.length;i++)shareWatchProfiles[i].off()}},getCurrentFileID=function(){return file?file.key():null},open=function(value){console.log("open"),file="new"!==value?files.child(value):null},save=function(value){var date=Firebase.ServerValue.TIMESTAMP;if(file){file.update({text:value,date:date,lastEditor:auth.deviceID});var userFile=user.child("files").child(file.key());userFile.setPriority(date)}else add(function(){console.log("added")},{text:value})},remove=function(id,callback){var key=file.key();file.off(),file.remove(callback),user.child("files").child(key).off(),user.child("files").child(key).remove()},migrate=function(){for(var i=0;i<migrateItems.length;i++){var item=migrateItems[i];"intro"!==item.key&&add(function(){},item)}App.storage.clear()},login=function(){var authType=device.mobile()?"authWithOAuthRedirect":"authWithOAuthPopup";firebase[authType]("google",function(error){console.log(error?"Login Failed!":"Login Success!")},{scope:"email"})},logout=function(){firebase.unauth()},updateUser=function(authData){var userData=authData[authData.provider].cachedUserProfile;users.once("value",function(dataSnapshot){var userExists=dataSnapshot.exists(),obj={provider:authData.provider,firstname:userData.given_name,lastname:userData.family_name,email:userData.email,picture:userData.picture,lastseen:Firebase.ServerValue.TIMESTAMP};userExists?user.update(obj,function(){console.log("Successfully updated"),migrate()}):user.set(obj,function(){console.log("Successfully signed up"),migrate()})},function(error){console.log("oh"),console.log(error)})};return{init:init,login:login,logout:logout,add:add,save:save,remove:remove,load:load,getSharers:getSharers,getCurrentFileID:getCurrentFileID,addSharer:addSharer,removeSharer:removeSharer,open:open}}();var ready=function(){head.js.apply(window,scripts).ready("autolink",function(){checkDevice(),App.view.init()})};window.cordova?document.addEventListener("deviceready",ready,!1):ready(),window.console=window.console||{log:function(){}};var checkDevice=function(){device.desktop()?(event_down="mousedown",event_move="mousemove",event_release="mouseup"):(event_down="touchstart",event_move="touchmove",event_release="touchend")};click="click",Object.size=function(obj){var key,size=0;for(key in obj)obj.hasOwnProperty(key)&&size++;return size};var savedSel=null,savedSelActiveElement=null,Data=function(){var warehouse={},count=1;return{reset:function(){count=1,warehouse={}},set:function(dom,data){dom.__data||(dom.__data="hello"+count++),warehouse[dom.__data]=data},get:function(dom){return warehouse[dom.__data]}}}();!function(){for(var lastTime=0,vendors=["webkit","moz"],x=0;x<vendors.length&&!window.requestAnimationFrame;++x)window.requestAnimationFrame=window[vendors[x]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[vendors[x]+"CancelAnimationFrame"]||window[vendors[x]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(callback){var currTime=(new Date).getTime(),timeToCall=Math.max(0,16-(currTime-lastTime)),id=window.setTimeout(function(){callback(currTime+timeToCall)},timeToCall);return lastTime=currTime+timeToCall,id}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(id){clearTimeout(id)})}();